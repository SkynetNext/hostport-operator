---
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: hostport-mutating-webhook-configuration
  labels:
    app.kubernetes.io/name: hostport-operator
webhooks:
  - name: mpod.hostport.io
    clientConfig:
      service:
        name: hostport-operator-webhook-service # 使用 kustomize namePrefix 后的实际 Service 名称
        namespace: operators
        path: "/mutate-pods"
    rules:
      - apiGroups:
          - ""
        apiVersions:
          - v1
        operations:
          - CREATE
        resources:
          - pods
    admissionReviewVersions:
      - v1
    sideEffects: None
    # 修改为 Ignore：即使 webhook 调用失败（如证书问题），也不会阻止 Pod 创建
    # 这样不会影响其他不需要 hostport 的 Pod
    failurePolicy: Ignore
    # 排除系统命名空间（通过命名空间的 kubernetes.io/metadata.name 标签）
    namespaceSelector:
      matchExpressions:
        - key: kubernetes.io/metadata.name
          operator: NotIn
          values:
            - kube-system
            - kube-public
            - kube-node-lease
            - operators
            - monitoring
            - istio-system
            - argocd
    # 排除 Operator 自己的 Pod，避免循环依赖
    # 注意：objectSelector 只能匹配 labels，不能直接匹配 annotations
    # 代码逻辑中会检查 hostport.io/enabled=true 注解，如果没有则快速返回 allowed
    objectSelector:
      matchExpressions:
        - key: app.kubernetes.io/name
          operator: NotIn
          values:
            - hostport-operator
---
apiVersion: v1
kind: Service
metadata:
  name: webhook-service
  namespace: operators # 修复：namespace 应该是 operators
  labels:
    app.kubernetes.io/name: hostport-operator
spec:
  ports:
    - port: 443
      targetPort: 9443
  selector:
    app.kubernetes.io/name: hostport-operator
